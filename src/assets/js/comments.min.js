!function(){"use strict";class e{constructor(){this._listeners=[],this.addListener=this.addListener.bind(this),this.removeAllListeners=this.removeAllListeners.bind(this)}addListener(e,n,t){e.addEventListener(n,t),this._listeners.push({el:e,name:n,listener:t})}removeAllListeners(){this._listeners.forEach(({name:e,listener:n,el:t})=>t.removeEventListener(e,n))}}const n=document.createElement("template");n.innerHTML='\n    <style>\n    :host {\n        display: block;        \n    }    \n    slot {\n        white-space: pre-line;\n    }\n    </style>\n    <div><slot class="body"></slot></div>\n';class t extends HTMLElement{constructor(){super(),this.root=this.attachShadow({mode:"open"}),this.root.appendChild(n.content.cloneNode(!0)),this._listeners=new e}connectedCallback(){const e=this.root.querySelector("slot.body");this._listeners.addListener(e,"slotchange",n=>{const t=e.assignedNodes()[0].outerHTML;console.log("TEXT",t,typeof t)})}disconnectedCallback(){this._listeners.removeAllListeners()}}customElements.define("comments-body-lines",t);const s=document.createElement("template");s.innerHTML='\n    <style>  \n    :host {\n        display: block;\n    }\n    .bg-light {\n        background-color: var(--light, #f8f9fa);\n    }\n    .card-body {\n        -ms-flex: 1 1 auto;\n        flex: 1 1 auto;\n        padding: 1.25rem;\n    }\n    .author {\n        font-weight: bold;\n        padding-right: 1em;\n    }\n    </style>\n    <div class="answer card-body bg-light">\n        <div>\n            <span class="author"><slot name="author">author</slot></span>\n            <commnents-date class="createdAt"><slot name="createdAt">createdAt</slot></commnents-date>\n        </div>\n        <div class="body">\n            <comments-body-lines><slot name="body">body</slot></comments-body-lines>\n        </div>\n    </div>\n';class i extends HTMLElement{constructor(){super(),this.root=this.attachShadow({mode:"open"}),this.root.appendChild(s.content.cloneNode(!0))}}customElements.define("comments-answer",i);const o=document.createElement("template");o.innerHTML='\n    <style>  \n    a {\n        color: var(--primary, mediumblue);\n        text-decoration: none;\n    }\n    ul {\n        margin: 0;\n        padding-left: 0;\n        list-style: none;\n        border-radius: .25rem;\n    }\n    li {\n        padding: .5rem .75rem;\n        display: block;\n    }\n    a {\n        border: none;\n        border-top-right-radius: .25rem;\n        border-bottom-right-radius: .25rem;    \n    }\n    a:hover {\n        background: inherit;\n    }\n    </style>\n    <nav>\n        <ul>\n            <li>\n                <a href="#">...</a>\n            </li>\n        </ul>\n    </nav>\n';class a extends HTMLElement{constructor(n="Load more..."){super(),this.root=this.attachShadow({mode:"open"}),this.root.appendChild(o.content.cloneNode(!0)),this.dispatchEvent=this.dispatchEvent.bind(this),this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.link=this.root.querySelector("a"),this.link.innerText=n,this._listeners=new e}connectedCallback(){this._listeners.addListener(this.link,"click",e=>{e.preventDefault(),this.dispatchEvent(new CustomEvent("pagination:next"))})}disconnectedCallback(){this._listeners.removeAllListeners()}show(){this.style.display="block"}hide(){this.style.display="none"}}customElements.define("comments-pagination",a);const r=document.createElement("template");r.innerHTML='\n    <style> \n    :host() {\n        display: none;\n    }\n    .loading {\n        height: 3em;\n        background-image: url("/assets/img/loading.gif");\n        background-repeat: no-repeat;\n        background-size: 2em 2em;\n        background-position: center;\n    }\n    </style>\n    <div class="loading"></div>\n';class h extends HTMLElement{constructor(){super(),this.root=this.attachShadow({mode:"open"}),this.root.appendChild(r.content.cloneNode(!0)),this.show=this.show.bind(this),this.hide=this.hide.bind(this)}connectedCallback(){this.getAttribute("hide")&&this.hide()}show(){this.style.display="block"}hide(){this.style.display="none"}}customElements.define("comments-loading",h);var d=function(e){return this.textContent=e,this.innerHTML}.bind(document.createElement("div"));function l(e){if(e)return e.replace(/(https?:\/\/[^\s)("<>]+)/g,e=>'<a href="'+e+'" target="_blank" rel="noopener noreferrer">'+e+"</a>")}const c=document.createElement("template");c.innerHTML='\n    <style>  \n    :host {\n        display: block;\n    }\n    a {\n        color: var(--primary, mediumblue);\n        text-decoration: none;\n    }\n    .author {\n        font-weight: bold;\n        padding-right: 1em;\n    }\n    .createdAt {\n        font-style: italic;\n    }\n    .reply {\n        float: right;\n    }\n    .answers {\n        border-left: 1em solid lightgray;\n    }\n    .mb-3 {\n        margin-bottom: 1rem!important;\n    }\n    .card {\n        word-wrap: break-word;\n        background-color: #fff;\n        background-clip: border-box;\n        border: 1px solid rgba(0,0,0,.125);\n        border-radius: .25rem;\n    }\n    .card-header {\n        padding: .75rem 1.25rem;\n        margin-bottom: 0;\n        background-color: rgba(0,0,0,.03);\n        border-bottom: 1px solid rgba(0,0,0,.125);\n    }\n    .card-body { \n        padding: 1.25rem;\n    }    \n    .leave-answer {\n        padding: 1em;\n        padding-bottom: 0.5em;\n    }\n    </style>\n    <div class="comment card mb-3">\n    <div class="card-header">\n        <span class="author"><slot name="author">author</slot></span>\n        <span class="createdAt"><slot name="createdAt">createdAt</slot></span>\n        <a class="reply" href="#">Reply</a>\n    </div>\n    <div class="body card-body">\n        <comments-body-lines><slot name="body">body</slot></comments-body-lines>\n    </div>\n    <div class="answers">\n        <div class="container"></div>\n        <div class="navigation"></div>\n        <div class="leave-answer" style="display: none">\n            <comments-leave-message>Your answer</comments-leave-message>\n        </div>\n    </div>\n';class m extends HTMLElement{constructor(){super(),this.root=this.attachShadow({mode:"open"}),this.root.appendChild(c.content.cloneNode(!0)),this.dispatchEvent=this.dispatchEvent.bind(this),this.showAnswer=this.showAnswer.bind(this),this.showPagination=this.showPagination.bind(this),this.hidePagination=this.hidePagination.bind(this),this.showLoading=this.showLoading.bind(this),this.hideLoading=this.hideLoading.bind(this);const n=this.root.querySelector(".answers");this.answersContainer=n.querySelector(".container"),this.loading=new h,this.loading.setAttribute("hide","true"),this.pagination=new a,this.leaveAnswer=n.querySelector("comments-leave-message"),this.leaveAnswerDiv=n.querySelector(".leave-answer"),this.reply=this.root.querySelector(".reply");const t=n.querySelector(".navigation");t.appendChild(this.loading),t.appendChild(this.pagination),this._listeners=new e}connectedCallback(){this._listeners.addListener(this.pagination,"pagination:next",e=>this.dispatchEvent(new CustomEvent("comment:next-answers"))),this._listeners.addListener(this.leaveAnswer,"leave-message:submit",e=>this.dispatchEvent(new CustomEvent("comment:leave-answer",e))),this._listeners.addListener(this.reply,"click",e=>{e.preventDefault(),this.leaveAnswerDiv.style.display="block",this.leaveAnswer.focus()})}disconnectedCallback(){this._listeners.removeAllListeners()}showAnswer(e){const n=new i;n.innerHTML=`\n            <span slot="author">${d(e.author)}</span>\n            <span slot="createdAt">${d(e.createdAt)}</span>\n            <span slot="body">${l(d(e.body))}</span>\n        `,this.answersContainer.appendChild(n)}showPagination(){this.pagination.show()}hidePagination(){this.pagination.hide()}showLoading(){this.loading.show()}hideLoading(){this.loading.hide()}}customElements.define("comments-comment",m);class p{constructor(){this.code=""}getCode(){return this.code}create(e){this.code=((e=4,n="23456789bcdfghkmnpqrstvwxyz")=>{let t="";for(let s=0;s<e;s++)t+=n.charAt(Math.floor(n.length*Math.random()));return t})(),((e,n)=>{const t=e.getContext("2d");t.clearRect(0,0,e.width,e.height);const s=t.createLinearGradient(0,0,e.width,0);s.addColorStop(0,"black"),s.addColorStop(1,"white");const i=t.createLinearGradient(0,0,e.width,0);i.addColorStop(0,"white"),i.addColorStop(1,"black"),t.fillStyle=s,t.fillRect(0,0,e.width,25),t.fillStyle=i,t.font="54px Courier New",t.fillText(n,15,40)})(e,this.code)}}const u=document.createElement("template");u.innerHTML='\n    <style>\n    :host {\n        display: block;\n    }\n    input, textarea {\n        display: block;\n        width: 100%;\n        padding: .375rem 0 .375rem .75rem;\n        margin-right: 1em;\n        font-size: 1rem;\n        line-height: 1.5;\n        color: #495057;\n        background-color: #fff;\n        border: 1px solid #ced4da;\n        border-radius: .25rem;\n        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;\n        box-sizing: border-box;\n    }\n    input.error , textarea.error {\n        border: 1px solid var(--red, red);\n    }\n    @media (min-width: 24em) {\n        .form-row.flex {\n            display: flex;\n        }\n        .small {\n            max-width: 10em;\n        }\n    }\n    textarea {\n        overflow: auto;\n        resize: vertical;\n        margin-right: 20px;\n        padding-right: 0;\n    }\n    button {\n        -webkit-appearance: button;\n        cursor: pointer;   \n        color: #fff;\n        background-color: var(--primary, mediumblue);\n        border-color: var(--primary, mediumblue);        \n        margin-bottom: .5rem!important;\n        display: inline-block;\n        font-weight: normal;\n        text-align: center;\n        white-space: nowrap;\n        vertical-align: middle;\n        user-select: none;\n        border: 1px solid transparent;\n        padding: .375rem .75rem;\n        font-size: 1rem;\n        line-height: 1.5;\n        border-radius: .25rem;\n        transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;\n    }\n    form {\n        display: block;\n    }\n    .form-row {\n        margin-bottom: 0.5rem;\n    }\n    .captcha {\n        padding-top: 0.2em;\n        padding-left: 0.5em;\n    }\n    .captcha canvas {\n        height: 2em;\n    }\n    .title {\n        font-size: 1.5em;\n        margin-bottom: 0.5em;\n    }\n    .alert {\n        position: relative;\n        padding: .75rem 1.25rem;\n        margin-bottom: 1rem;\n        border: 1px solid transparent;\n        border-radius: .25rem;\n    }\n    .alert.success {\n        color: var(--green, green);\n        background-color: #d4edda;\n        border-color: var(--green, green);\n    }\n    .alert.error {\n        color: var(--red, red);\n        background-color: #ffe6e6;\n        border-color: var(--red, red);\n    }\n    </style>\n    <div class="title"><slot>Leave a comment</slot></div>\n    <form method="post">\n        <div class="alert error" style="display: none"></div>\n        <div class="alert success" style="display: none"></div>\n        <div class="form-row flex">\n            <div>\n                <input name="name" maxLength="50" placeholder="Name"/>\n            </div>\n        </div>\n        <div class="form-row flex">\n            <div>\n                <input name="captcha" maxLength="10" placeholder="Captcha" autocomplete="off"/>\n            </div>\n            <div class="captcha">\n                <canvas id="captcha" width="170" height="60"></canvas>\n            </div>          \n        </div>\n        <div class="form-row">\n            <div>\n                <textarea name="message" rows="5" maxLength="1000"></textarea>\n            </div>\n        </div>\n        <div class="form-row">\n            <button type="submit">Submit</button>\n        </div>\n    </form>\n';class g extends HTMLElement{constructor(){super(),this.root=this.attachShadow({mode:"open"}),this.root.appendChild(u.content.cloneNode(!0)),this.dispatchEvent=this.dispatchEvent.bind(this),this.onFormSubmit=this.onFormSubmit.bind(this),this.reloadCaptcha=this.reloadCaptcha.bind(this),this.checkMaxChars=this.checkMaxChars.bind(this),this.showSuccess=this.showSuccess.bind(this),this.showError=this.showError.bind(this),this.cleanAlert=this.cleanAlert.bind(this),this.focus=this.focus.bind(this),this.captchaFn=new p,this.captchaCanvas=this.root.querySelector("canvas#captcha"),this.form=this.root.querySelector("form"),this.submitListener=e=>e.preventDefault()&this.onFormSubmit(),this.error=this.root.querySelector(".alert.error"),this.success=this.root.querySelector(".alert.success"),this.name=this.form.querySelector("input[name=name]"),this.captcha=this.form.querySelector("input[name=captcha]"),this.message=this.form.querySelector("textarea[name=message]"),this._listeners=new e}connectedCallback(){this._listeners.addListener(this.form,"submit",this.submitListener),this._listeners.addListener(this.captchaCanvas,"click",this.reloadCaptcha),this._listeners.addListener(this.message,"keyup",this.checkMaxChars),this.reloadCaptcha()}disconnectedCallback(){this._listeners.removeAllListeners()}onFormSubmit(){const e=this.name.value.trim().substring(0,50),n=this.message.value.trim().substring(0,1e3),t=this.captcha.value.trim();this.name.classList.remove("error"),this.captcha.classList.remove("error"),this.message.classList.remove("error");let s=!1;e||(this.name.classList.add("error"),s=!0),t||(this.captcha.classList.add("error"),s=!0),n||(this.message.classList.add("error"),s=!0),t.toUpperCase()!==this.captchaFn.getCode().toUpperCase()&&(this.showError("Captcha doesn't seem to match"),this.captcha.classList.add("error"),this.captcha.value="",this.reloadCaptcha(),s=!0),s||(this.dispatchEvent(new CustomEvent("leave-message:submit",{detail:{name:e,message:n}})),this.name.value="",this.captcha.value="",this.message.value="",this.reloadCaptcha(),this.showSuccess("Thanks for your message!"))}checkMaxChars(){this.cleanAlert(),this.message.value.length>=1e3&&this.showError("Only 1000 characters please.")}reloadCaptcha(){this.captchaFn.create(this.captchaCanvas)}showSuccess(e){this.cleanAlert(),this.success.innerHTML=e,this.success.style.display="block",setTimeout(()=>this.success.style.display="none",3e3)}showError(e){this.cleanAlert(),this.error.innerHTML=e,this.error.style.display="block"}cleanAlert(){this.error.style.display="none",this.success.style.display="none"}focus(){this.name.focus()}}customElements.define("comments-leave-message",g);class v{constructor(e="/",n){this.serviceEndpoint=e,this.commentsHref=`post/${n}/comments`}loadComments(e=this.commentsHref){return console.debug("Calling service for comments",new URL(e,this.serviceEndpoint)),fetch(new URL(e,this.serviceEndpoint).href).then(e=>e.json()).catch(e=>console.error("Cannot load comments:",e))}loadAnswers(e){return console.debug("Calling service for answers",new URL(e,this.serviceEndpoint)),fetch(new URL(e,this.serviceEndpoint).href).then(e=>e.json()).catch(e=>console.error("Cannot load answers:",e))}saveComment({name:e,message:n}){return console.debug("Calling service for saving a comment",new URL(this.commentsHref,this.serviceEndpoint)),fetch(new URL(this.commentsHref,this.serviceEndpoint).href,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:b({body:n,author:e})}).then(e=>e.json()).catch(e=>console.error("Cannot save an comment:",e))}saveAnswer(e,{name:n,message:t}){return console.debug("Calling service for saving an answer",new URL(this.commentsHref,this.serviceEndpoint)),fetch(new URL(this.commentsHref+"/"+e,this.serviceEndpoint).href,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:b({body:t,author:n})}).then(e=>e.json()).catch(e=>console.error("Cannot save an answer:",e))}}function b(e){return Object.keys(e).reduce((n,t)=>n+`&${t}=${encodeURIComponent(e[t])}`,"")}const w=document.createElement("template");w.innerHTML='\n    <style>\n    :host {\n        display: block;\n    }\n    a {\n        color: var(--primary, mediumblue);\n        text-decoration: none;\n    }\n    comments-leave-message {\n        margin-bottom: 2em;\n    }\n    </style>\n    <comments-leave-message>Leave a comment</comments-leave-message>\n    <div class="comments">\n        <div class="container"></div>    \n    </div>    \n';class y extends HTMLElement{constructor(){super(),this.root=this.attachShadow({mode:"open"}),this.root.appendChild(w.content.cloneNode(!0)),this.loadComments=this.loadComments.bind(this),this.showComment=this.showComment.bind(this),this.loadAnswers=this.loadAnswers.bind(this),this.leaveComment=this.leaveComment.bind(this),this.leaveAnswer=this.leaveAnswer.bind(this),this.service=new v(this.getAttribute("service"),this.getAttribute("postId")),this.comments=this.root.querySelector(".comments"),this.commentsContainer=this.comments.querySelector(".container"),this.leaveMessage=this.root.querySelector("comments-leave-message"),this.loading=new h,this.nextCommentsListener={handle:()=>{}},this.nextAnswersListeners=[],this.pagination=new a("Load more comments..."),this.comments.appendChild(this.loading),this.comments.appendChild(this.pagination),this._listeners=new e}connectedCallback(){this._listeners.addListener(this.leaveMessage,"leave-message:submit",({detail:e})=>this.leaveComment(e)),this._listeners.addListener(this.pagination,"pagination:next",e=>this.nextCommentsListener.handle()),this.loadComments()}disconnectedCallback(){this._listeners.removeAllListeners()}loadComments(e){this.pagination.hide(),this.loading.show(),this.service.loadComments(e).then(f).then(e=>{e.comments.forEach(e=>this.showComment(e,!1)),e.next&&(this.pagination.show(),this.nextCommentsListener.handle=()=>this.loadComments(e.next))}).finally(this.loading.hide)}showComment(e,n=!1){const t=new m;if(t.innerHTML=`\n            <span slot="author">${d(e.author)}</span>\n            <span slot="createdAt">${d(e.createdAt)}</span>\n            <span slot="body">${l(d(e.body))}</span>\n        `,this._listeners.addListener(t,"comment:leave-answer",({detail:n})=>this.leaveAnswer(e.id,n,t)),e.answers&&e.answers.forEach(t.showAnswer),e.next){const n=n=>this.loadAnswers(t,e.next);this.nextAnswersListeners[t.id]={handle:n},this._listeners.addListener(t,"comment:next-answers",e=>this.nextAnswersListeners[t.id].handle()),t.showPagination()}else t.hidePagination();n?this.commentsContainer.insertBefore(t,this.commentsContainer.firstChild):this.commentsContainer.appendChild(t)}loadAnswers(e,n){e.hidePagination(),e.showLoading(),this.service.loadAnswers(n).then(L).then(n=>{n.answers.forEach(e.showAnswer),n.next&&(this.nextAnswersListeners[e.id].handle=()=>this.loadAnswers(e,n.next),e.showPagination())}).finally(e.hideLoading)}leaveComment({name:e,message:n}){this.service.saveComment({name:e,message:n}).then(C).then(e=>this.showComment(e,!0))}leaveAnswer(e,{name:n,message:t},s){this.service.saveAnswer(e,{name:n,message:t}).then(C).then(s.showAnswer)}}function f(e){return{...e,comments:(e.comments||[]).map(C).map(L)}}function C(e){return{...e,createdAt:(n=e.createdAt,new Date(parseInt(1e3*n)).toLocaleDateString())};var n}function L(e){return{...e,answers:(e.answers||[]).map(C)}}customElements.define("comments-app",y)}();
